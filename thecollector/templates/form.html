{% extends "layout.html" %}
{% set title = _('The form') %}
{% block content %}
<div class="btn-group mb-3 w-100" role="group">
    <a href="{{ url_for('guideline') }}" class="btn btn-info">{{ _('Guideline') }}</a>
    <div class="d-flex">
        <button id="rtl" type="button" class="btn btn-secondary" data-bs-toggle="button" autocomplete="off" aria-pressed="false">{{ _("Toggle direction") }}</button>
    </div>
</div>
    <form method="{{ method if method else 'POST' }}" action="{{ action if action else '' }}" autocomplete="off" id="dataform">
        {{ form.hidden_tag() }}
        {% if sign %}
            <div class="input-group mb-3">
                {{ form.sign.label(class="input-group-text") }}
                {% if form.sign.errors %}
                    {{ form.sign(value=sign, readonly="", placeholder=_("A sign that you wrote this..."), class="is-invalid form-control", aria_describedby="%sfeedback"%form.sign.id) }}
                    <div id="{{ form.sign.id }}feedback" class="d-block invalid-feedback">
                        {% for error in form.sign.errors %}
                            <span>{{ error }}</span>&nbsp;
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.sign(value=sign, readonly="", placeholder=_("A sign that you wrote this..."), class="form-control") }}
                {% endif %}
            </div>
        {% endif %}
        <div class="input-group mb-3">
            {{ form.title.label(class="input-group-text") }}
            {% if form.title.errors %}
                {{ form.title(placeholder=_("(Wikipedia) Title for your content..."), class="is-invalid form-control", aria_describedby="%sfeedback"%form.title.id) }}
                <div id="{{ form.title.id }}feedback" class="d-block invalid-feedback">
                    {% for error in form.title.errors %}
                        <span>{{ error }}</span>&nbsp;
                    {% endfor %}
                </div>
            {% else %}
                {{ form.title(placeholder=_("(Wikipedia) Title for your content..."), class="form-control") }}
            {% endif %}
        </div>
        <div class="input-group mb-3">
            {{ form.context.label(class="input-group-text") }}
            {% if form.context.errors %}
                {{ form.context(placeholder=_("Some story here..."), class="is-invalid form-control h-auto", aria_describedby="%sfeedback"%form.context.id) }}
                <div id="{{ form.context.id }}feedback" class="d-block invalid-feedback">
                    {% for error in form.context.errors %}
                        <span>{{ error }}</span>&nbsp;
                    {% endfor %}
                </div>
            {% else %}
                {{ form.context(placeholder=_("Some story here..."), class="form-control h-auto") }}
            {% endif %}
            {% if form.context.render_kw.minlength %}
                <span class="input-group-text ltr"><sup id="contextcount">0</sup>&frasl;<sub>{{ form.context.render_kw.minlength }}</sub></span>
            {% endif %}
        </div>
        {% for pair in form.answerables %}
            {% set answer_feedback = "answer%sfeedback"%loop.index %}
            <div class="mt-3 pb-3 px-3 pt-1 border">
                <span>{{ _("Pair") }} #{{ loop.index }}</span>
                <div class="input-group mb-1 mt-2">
                    {{ pair.question.label(class="input-group-text") }}
                    {% if pair.question.errors %}
                        {{ pair.question(class="is-invalid form-control", aria_describedby="%sfeedback"%pair.question.id) }}
                        <div id="{{ pair.question.id }}feedback" class="d-block invalid-feedback">
                            {% for error in pair.question.errors %}
                                <span>{{ error }}&nbsp;</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ pair.question(class="form-control") }}
                    {% endif %}
                </div>
                <div class="input-group mb-1">
                    {{ pair.text.label(class="input-group-text") }}
                    {{ pair.text(class="form-control" + (" is-invalid" if pair.text.errors else ""), aria_describedby=answer_feedback) }}
                </div>
                <div class="input-group mb-1">
                    {{ pair.start.label(class="input-group-text") }}
                    {{ pair.start(class="form-control" + (" is-invalid" if pair.start.errors else "") , aria_describedby=answer_feedback) }}
                    {{ pair.end.label(class="input-group-text") }}
                    {{ pair.end(class="form-control" + (" is-invalid" if pair.end.errors else "") , aria_describedby=answer_feedback) }}
                </div>
                <div class="input-group input-group-sm">
                    <span class="input-group-text">{{ _("Selected in the context") }}</span>
                    <span readonly class="form-control" id="tipline{{ loop.index }}"></span>
                    <button id="prev{{ loop.index }}" class="btn btn-outline-secondary" type="button">« {{ _("Pre") }}</button>
                    <button id="next{{ loop.index }}" class="btn btn-outline-secondary" type="button">{{ _("Next") }} »</button>
                </div>
                {% if pair.text.errors or pair.start.errors or pair.end.errors %}
                    <div id="{{ answer_feedback }}" class="d-block invalid-feedback">
                        {% for error in pair.text.errors %}
                            <span>{{ error }}&nbsp;</span>
                        {% endfor %}
                        {% for error in pair.start.errors %}
                            <span>{{ error }}&nbsp;</span>
                        {% endfor %}
                        {% for error in pair.end.errors %}
                            <span>{{ error }}&nbsp;</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        {% endfor %}
        <div class="mt-3 pb-3 px-3 pt-1 border">
            <span>{{ _("Impossible questions") }}</span>
            {% for pair in form.impossibles %}
                {% set feedback = "answer%sfeedback"%loop.index %}
                    <div class="input-group mb-2 mt-2">
                        {{ pair.question.label(class="input-group-text", text="{} #{}".format(pair.question.label.text, loop.index)) }}
                        {% if pair.question.errors %}
                            {{ pair.question(class="is-invalid form-control", aria_describedby=feedback) }}
                            <div id="{{ feedback }}" class="d-block invalid-feedback">
                                {% for error in pair.question.errors %}
                                    <span>{{ error }}&nbsp;</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ pair.question(class="form-control") }}
                        {% endif %}
                    </div>
            {% endfor %}
        </div>
        {{ form.submit(class="btn btn-lg btn-success px-max mt-3 w-100") }}
    </form>
{% endblock content %}

{% block scripts %}
    <script type="text/javascript">
        {# RTL switch #}
        let rtlbtn = document.getElementById('rtl');
        let html = document.querySelector('html');
        if (html.getAttribute("dir") == "rtl") {
            rtlbtn.setAttribute("aria-pressed", "true");
            rtlbtn.classList.add("active");
        } else {
            html.setAttribute("dir", "ltr");
            rtlbtn.setAttribute("aria-pressed", "false");
            rtlbtn.classList.remove("active");
        }
        rtlbtn.onclick = function() {
            if (rtlbtn.getAttribute("aria-pressed") == "true") {
                html.setAttribute("dir", "ltr");
                rtlbtn.setAttribute("aria-pressed", "false");
                rtlbtn.classList.remove("active");
            } else {
                html.setAttribute("dir", "rtl");
                rtlbtn.setAttribute("aria-pressed", "true");
                rtlbtn.classList.add("active");
            }
        }
    </script>
    <script type="text/javascript">
        {#  Global elements #}
        let context_field = document.getElementById('{{ form.context.id }}');
        let answer_fields = document.querySelectorAll('input[id^="{{ form.answerables.id }}"][id$="text"]');
        let start_fields = document.querySelectorAll('input[id^="{{ form.answerables.id }}"][id$="start"]');
        let end_fields = document.querySelectorAll('input[id^="{{ form.answerables.id }}"][id$="end"]');
        let tiplines = document.querySelectorAll('span[id^="tipline"]');
        let prevs = document.querySelectorAll('button[id^="prev"]');
        let nexts = document.querySelectorAll('button[id^="next"]');
        let context_count = document.getElementById('contextcount');
        {# occurrences is a 2D array like [i:[occurrences], i2:[occurrences], ..., n] where n is the lenght of answers. It holds indices of found answers in the context. #}
        let occurrences = [...Array(answer_fields.length)].map(e => Array());

        {# Functions #}
        function getIndicesOf(searchStr, str, caseSensitive) {
            {# Helper function for string search #}
            var searchStrLen = searchStr.length;
            if (searchStrLen == 0) {
                return [];
            }
            var startIndex = 0, index, indices = [];
            if (!caseSensitive) {
                str = str.toLowerCase();
                searchStr = searchStr.toLowerCase();
            }
            while ((index = str.indexOf(searchStr, startIndex)) > -1) {
                indices.push(index);
                startIndex = index + searchStrLen;
            }
            return indices;
        }

        function update_tipline(id) {
            let i = Number(start_fields[id].value);
            let j = Number(end_fields[id].value);
            let text = context.value.substring(i, j);
            if (text != "") {
                text = context.value.substring(i-30, i) + "<mark>" + text + "</mark>" + context.value.substring(j, j+30);
                if (i-50 > 0)
                    text = "..." + text;
                if (context.value.length > j+50)
                    text = text + "...";
                tiplines[id].innerHTML = text;
            }
        }

        let refresh_form = function() {
            context.value = context.value.replace(/\s?\n/g, " ");
            answer_fields.forEach(function(el, id) {
                update_tipline(id);
                update_index(id);
            });
            context_count.innerHTML = context.value.length;
        }

        function revolve(ntimes, id) {
            {# Switch to the next or prev occurrence #}
            let i = occurrences[id].indexOf(Number(start_fields[id].value));
            if (i != -1) {
                i = i + ntimes;
                i = occurrences[id][i];
                if (typeof i != "undefined") {
                    start_fields[id].value = i;
                    end_fields[id].value = Number(i) + answer_fields[id].value.length;
                }
            }
        }

        function update_index(id) {
            {# Find indexes when answer gets updated #}
            occurrences[id] = getIndicesOf(answer_fields[id].value, context_field.value);
            if (occurrences[id].length < 0) {
                start_fields[id].value = "";
                end_fields[id].value = "";
            } else {
                let i = Number(occurrences[id][0]);
                start_fields[id].value = i;
                end_fields[id].value = i + answer_fields[id].value.length;
            }
            update_tipline(id);
        }

        function update_answer(id) {
            {# Order is very important for the conditions here #}
            end_fields[id].setAttribute("min", start_fields[id].value);
            if (end_fields[id].value.length > 2 && end_fields[id].value <= start_fields[id].value)
                end_fields[id].value = Number(start_fields[id].value) + 1;
            else if (end_fields[id].value.length > 2 && end_fields[id].value < end_fields[id].getAttribute("min"))
                end_fields[id].value = end_fields[id].getAttribute("min");
            else if (end_fields[id].value > context_field.value.length)
                end_fields[id].value = context_field.value.length;
            if (Number(start_fields[id].value) - Number(end_fields[id].value) != 0)
                answer_fields[id].value = context_field.value.substring(start_fields[id].value, end_fields[id].value);
            if (end_fields[id].value == "0")
                start_fields[id].value = 0;
            else if (!(end_fields[id].value == "" || end_fields[id].value == null) && start_fields[id].value >= end_fields[id].value)
                start_fields[id].value = Number(end_fields[id].value) - 1;
            update_tipline(id);
        }

        function bind_anychange(el, func) {
            el.onchange = func;
            el.onkeydown = func;
            el.onpaste = func;
            el.oninput = func;
        }

        function bind_update_props(el, id, step) {
            el.onclick = function() {
                revolve(step, id);
                update_tipline(id);
            }
        }

        {# Binds #}
        bind_anychange(context_field, refresh_form);
        prevs.forEach(function(el, id) { bind_update_props(el, id, -1); });
        nexts.forEach(function(el, id) { bind_update_props(el, id, 1); });
        answer_fields.forEach(function(el, id) {
            let agg = function() { update_index(id); }
            el.onkeydown = agg;
            el.oninput = agg;
            agg = function() {
                update_index(id);
                answer_fields[id].value = answer_fields[id].value.trim();
            }
            el.onchange = agg;
            el.onpaste = agg;
        });
        start_fields.forEach(function(el, id) { bind_anychange(el, function() { update_answer(id); }); });
        end_fields.forEach(function(el, id) { bind_anychange(el, function() { update_answer(id); }); });
        document.getElementById('dataform').onsubmit = function() {
            refresh_form();
            return true;
        }
    </script>
{% endblock scripts %}

{% block style %}
    textarea {
        resize: none;
    }
    .square-top {
        border-top-right-radius: 0;
        border-top-left-radius: 0;
    }
    html[dir="rtl"] .input-group,
    html[dir="rtl"] .btn-group {
        padding-left: 1px;
    }
    html[dir="rtl"] .square-top-right {
        border-top-left-radius: 0;
    }
    html[dir="rtl"] .square-top-left {
        border-top-right-radius: 0;
    }
    .square-top-left {
        border-top-left-radius: 0;
    }
    .square-top-right {
        border-top-right-radius: 0;
    }
    .square-bottom {
        border-bottom-right-radius: 0;
        border-bottom-left-radius: 0;
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button,
    input[type=number] {
        -webkit-appearance: none;
        -moz-appearance: textfield;
        margin: 0;
    }
{% endblock style %}
